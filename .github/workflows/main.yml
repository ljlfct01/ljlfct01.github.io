name: Sync External Repository
on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Set up Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        # è®¾ç½®å®½æ¾çš„æƒé™
        git config --global --add safe.directory '*'

    - name: Clone and sync external repo
      run: |
        set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
        
        # æ¸…ç†ç›®æ ‡æ–‡ä»¶å¤¹
        rm -rf external-folder
        mkdir -p external-folder
        
        # å…‹éš†å¤–éƒ¨ä»“åº“ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        max_retries=3
        retry_count=0
        
        while [ $retry_count -lt $max_retries ]; do
          echo "Clone attempt $((retry_count+1)) of $max_retries"
          if git clone --depth 1 --branch main https://github.com/ljlfct01/ljlfct01.github.io.git /tmp/external-repo; then
            echo "Clone successful"
            break
          else
            retry_count=$((retry_count+1))
            if [ $retry_count -eq $max_retries ]; then
              echo "Failed to clone after $max_retries attempts"
              exit 1
            fi
            echo "Retrying in 5 seconds..."
            sleep 5
          fi
        done
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼‰
        cd /tmp/external-repo
        # ä½¿ç”¨rsyncï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–cp
        if command -v rsync &> /dev/null; then
          rsync -av --exclude='.git' . ../external-folder/
        else
          # ä½¿ç”¨cpå¤åˆ¶æ‰€æœ‰æ–‡ä»¶
          shopt -s dotglob
          cp -r ./* ../external-folder/ 2>/dev/null || true
          # å¤åˆ¶éšè—æ–‡ä»¶ï¼ˆæ’é™¤.gitï¼‰
          for file in .[!.]*; do
            [[ "$file" != ".git" ]] && cp -r "$file" ../external-folder/ 2>/dev/null || true
          done
        fi
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        cd -
        rm -rf /tmp/external-repo
        
    - name: Pull latest changes
      run: |
        # æ‹‰å–æœ€æ–°å˜æ›´ï¼Œé¿å…æ¨é€å†²çª
        git pull --rebase origin main || echo "Pull failed, continuing..."

    - name: Commit and push changes
      run: |
        # æ·»åŠ æ‰€æœ‰å˜æ›´
        git add external-folder/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
        if git diff --cached --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # æäº¤å˜æ›´
        git commit -m "ğŸ”€ chore: sync external repository [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]"
        
        # æ¨é€å˜æ›´ï¼ˆå¸¦é‡è¯•ï¼‰
        max_retries=3
        retry_count=0
        
        while [ $retry_count -lt $max_retries ]; do
          if git push origin main; then
            echo "Push successful"
            break
          else
            retry_count=$((retry_count+1))
            echo "Push attempt $retry_count failed"
            
            if [ $retry_count -eq $max_retries ]; then
              echo "Failed to push after $max_retries attempts"
              exit 1
            fi
            
            echo "Retrying after pull..."
            git pull --rebase origin main
            sleep 2
          fi
        done
